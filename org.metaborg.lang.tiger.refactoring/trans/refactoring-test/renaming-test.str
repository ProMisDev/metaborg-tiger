module renaming-test

imports 
	signatures/-
	nabl2/api
	pp
	libspoofax/stratego/debug
	refactoring/renaming
	
rules //spt-dev

  debog-test(|t) : ast -> ast 
  where
  	<ppdebug0> t
  	
  debog-test-multiargs(|t1, t2, t3) : ast -> ast 
  where
  	<ppdebug1> t1  	
  	;<ppdebug2> t2
  	;<ppdebug3> t3
  	
  debog-test-noargs : ast -> ast
  where	
  	<ppdebug0> "Test No Args"  	



rules // rules called by spt
  rename-test-var : ast -> result
    where
      old-name := "msg"
      ; new-name := "message"
      ; path := "test/variables.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast
    	
  rename-test-var-capture : ast -> result
    where
      old-name := "y"
      ; new-name := "x"
      ; path := "test/variables.spt"
    	; result := <rename-action-test(id | old-name, new-name, path)> ast
    	
  rename-test-type : ast -> result
    where
      old-name := "student"
      ; new-name := "person"
      ; path := "test/types.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast
    	
  rename-test-field : ast -> result
    where
      old-name := "name"
      ; new-name := "fullName"
      ; path := "test/types.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast
 
  rename-test-function : ast -> result
    where
      old-name := "plus"
      ; new-name := "add"
      ; path := "test/functions.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast
    	
  rename-test-procedure : ast -> result
    where
      old-name := "printnl"
      ; new-name := "printNewLine"
      ; path := "test/functions.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast

  rename-test-farg : ast -> result
    where
      old-name := "x"
      ; new-name := "text"
      ; path := "test/functions.spt"
    	; result := <rename-action-test(fail | old-name, new-name, path)> ast
    	
  rename-test-farg-capture : ast -> result
    where
      old-name := "d"
      ; new-name := "a"
      ; path := "test/functions.spt"
    	; result := <rename-action-test(id | old-name, new-name, path)> ast

rules     	  
    rename-action-test(capture-expected |old-name,  new-name, path): ast -> result
    where
    	analysis := <nabl2-get-ast-analysis> ast;
      <not(nabl2-analysis-has-errors)> analysis
    with
    selected-occ := <get-target-dec-occ-test(|analysis, old-name)> ast 
    ; resolution-relation := <calc-resolution-relation> analysis
	  ; target-indices := <calc-name-cluster> (selected-occ, resolution-relation)
		; renamed-ast := <rename-ast(|target-indices, new-name)> ast
		; if capture-expected
		then not(check-capture(|renamed-ast, resolution-relation, path))
		else check-capture(|renamed-ast, resolution-relation, path) end
    ; result := renamed-ast
    	  
  get-target-dec-occ-test(|analysis, old-name): ast -> occ-index
	where
		occs := <get-all-occs(|analysis)> analysis
		; selected-occ := <collect-one(get-occurrence-test(|occs, old-name))> ast
    ; target-dec-occ := <resolve-occ(|analysis)> selected-occ
    ; occ-index := <get-term-index-from-occ> target-dec-occ
    
  get-occurrence-test(|occs, old-name): t -> occurrence
	where
		<is-string> t
		; <eq-no-annos> (old-name, t)
		; term-index := <nabl2-get-ast-index> t
		; occurrence := <fetch-elem(occ-eq-term-index(|term-index))> occs
		
	eq-no-annos: (term1, term2) -> (term1, term2) 
	where
	  <eq> (<strip-annos> term1, <strip-annos> term2) 
	  
  resolve-occ(|analysis): selected-occ -> target-dec-occ
  where
  	if (dec-occ, _) := <nabl2-get-resolved-name(|analysis)> selected-occ then
  		target-dec-occ := dec-occ
  	else
  		target-dec-occ := selected-occ
  	end
    